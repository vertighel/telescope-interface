<style>
 .sbc_top{
     padding: 1rem;
     flex: 1 1 auto;
     display: flex;
     flex-direction: column;
     justify-content: center;
     align-items: center;
 }
 .sbc_status{
     font-size:1.3em;
 }

 .control_view{
     flex: 1 1 auto;
     display: flex;
     flex-direction: column;
 }

 .sb_camera_info{
     flex: 1 1 auto;
     display: flex;
     flex-direction: column;
     justify-content: center;
     align-items: center;
 }
 
 .controls{
     flex: 1 1 auto;

 }

 .image_panel{

     display: flex;
     flex: 1 1 auto;
     flex-direction: column;
     border: 1px solid grey;
     min-height: 100vh;
 }
 .image_panel>h3{
     flex: 0 1 auto;
 }

</style>

<div class="sbc_top">
    <!-- <span data-var="status" class="text-strong sbc_status"></span>
       -->
    <div class="sb_camera_info">
	<h3><span data-var="title"></span>
	    <!-- <button data-var="use_camera" class="btn btn-primary">Use camera</button> -->
	</h3>
	
	<x-widget name="camera_button" data-class="action"> </x-widget> 
    </div>

    
    
    <div data-var="control_view" class="control_view">
	<section data-var="controls" class="controls">
	    <x-widget name="temp_monitor" data-class="ti/temp_monitor"> </x-widget>
	    <x-widget name="ccd_settings" data-class="ti/camera-ccd"></x-widget>
	    <x-widget name="object_settings" data-class="ti/camera-object"></x-widget>
	    <x-widget name="control_widget" data-class="ti/camera-controls"></x-widget>
	</section>
	
	<section class="image_panel">
	    <h4>Last image : <span data-var="image_name"></span></h4>    
	    <x-widget name="viewer" data-class="fits_viewer" data-fits-file="lib/fits/ngc6934_v.fits"></x-widget>
	</section>
    </div>
</div>

<script class="builder">
 var sbc=this;
 sbc.controls.disabled=true;

 var camb=sbc.childs.camera_button;

 var ccd_settings=sbc.childs.ccd_settings;
 
 function show_control_view(enable){
     sbc.control_view.style.display=enable? "" : "none";
 }


 
 
 
 class sbig_camera{
     
     constructor(){
	 this.locked=false;
	 this.owner=false;
	 
	 
     }

     init(sock, info){
	 var cam=this;
	 this.sock=sock;
	 this.info=info;
	 sbc.title.innerHTML=info.name + "<small>, serial "+info.serial+"</small>";
	 sbc.update_button();

	 this.sock.query("sbig/get_ob_template", function(reply){
	     cam.ob_template=reply.data;
	 });

	 
	 sbc.childs.control_widget.expose.addEventListener("click", function(){
	     console.log("Expose!");
	     cam.fill_ob(sbc.cam.ob_template, sbc);
	     console.log("Filled OB + " + JSON.stringify(cam.ob_template, null, 5));
	     //sbc.childs.ccd_settings
	     
	     cam.sock.query("sbig/submit_ob", { ob : cam.ob_template, cam_id : cam.info.id }, function(reply){
		 
	     });
	 });

     }
     
     use(cb){
	 var cam=this;
	 return new Promise(function(ok,fail){
	     if(cam.locked==true){
		 if(cam.owner==true){
		     cam.sock.query("sbig/release_camera", { cam_id : cam.info.id },function(reply){ 
			 if(reply.error!==undefined)
			     return fail(new Error(reply.error));
			 else{
			     cam.locked=false;
			     cam.owner=false;
			     
			     return ok(reply.data);
			 }
			 
		     }).catch(fail);
		 } else fail(new Error("use: camera locked and you are not the camera owner!"));
	     
	     }
	     else{
		 cam.sock.query("sbig/use_camera", { cam_id : cam.info.id },function(reply){
		     //console.log("use reply : " + JSON.stringify(reply));
		     if(reply.error!==undefined)
			 fail(new Error(reply.error));
		     else{
			 cam.locked=true;
			 cam.owner=true;
			 if(reply.data.type=="success")
			     ok(reply.data);
			 else {
			     cb(reply.data);
			 }
		     }

		     var ob_template;
		     
		     
		 }).catch(fail);
	     }
	 });
     }

     fill_ob(template, top_widget){
	 var cam=this;
	 for(var tpn in template.objects){
	     let tp=template.objects[tpn];	     
	     var widg=
		 (top_widget.childs!==undefined) ?
		 top_widget.childs[tpn] : top_widget; 

	     if(tp.objects !== undefined){
		 cam.fill_ob(tp, widg);
	     }else{
		 if(widg[tpn]!==undefined){
		     var type=widg[tpn].getAttribute("type");
		     switch(type){
			 case "checkbox":
			     tp.value=widg[tpn].checked;
			     break;
			 default:
			     tp.value=widg[tpn].value;
		     }
		     
		 }
	     }
	 }
	 
     }
     
     
 };
 
 


 sbc.monitor_temperature=function(enable){
     
     if(enable && sbc.temp_monitor!==undefined) return;
     if(!enable && sbc.temp_monitor===undefined) return;
     if(!enable){
	 clearInterval(sbc.temp_monitor);
	 sbc.temp_monitor=undefined;
     }else{
	 
	 sbc.temp_monitor=setInterval(function(){

	     if(sbc.cam.locked==false || sbc.cam.owner==false) { clearInterval(sbc.temp_monitor); return; }
	     if(sbc.cam.sock===undefined) { clearInterval(sbc.temp_monitor); return; }
	     
	     sbc.cam.sock.query("sbig/get_cooling_info", { cam_id : sbc.cam.info.id },function(reply){
		 console.log("Temperature " + JSON.stringify(reply.data));
		 var cool=reply.data;
		 ccd_settings.set_params(
		 {
		     cooling : {
			 setpoint : cool.cooling_setpoint,
			 enabled : cool.enabled,
			 ccd_temp : cool.ccd_temp,
			 ambient_temp : cool.ambient_temp
		     }
		 }
		 );
		 
		 sbc.childs.temp_monitor.update_temp(cool.ccd_temp);
	     });
	     
	     
	 }, 1000);
     }
 }
 
 
 sbc.update_button=function(){
     console.log("Update button!!");
     
     if(sbc.cam.locked==true){
	 if(sbc.cam.owner==true){

	     camb.start({ message: "You can now control the camera!", button_message : "Release camera",
			  start_cb : function(){
			      console.log("RELEASE CLICK!");
			      camb.wait({ message : "Releasing camera ..." });
			      sbc.cam.use().then(function(){
				  console.log("Release done!");
				  sbc.update_button();
			      }).catch(function(m){
				  camb.error({ message : "Error releasing camera : " + m, button_message : "Retry",
					       error_cb : sbc.update_button
				  });
			      });
			  }});
	     
	     
	     //sbc.status.innerHTML="You can now control the camera!";
	     
	     //sbc.use_camera.disabled=false;
	     //sbc.use_camera.innerHTML="Release camera";
	     //sbc.use_camera.className="btn btn-danger";

	     show_control_view(true);
	     
	 }else{

	     camb.start({ message: "The camera is controlled by someone else. Please wait!"});
	     

	     /* sbc.status.innerHTML="The camera is controlled by someone else. Please wait!";
		sbc.use_camera.innerHTML="Camera in use";
		sbc.use_camera.className="btn btn-default";
		sbc.use_camera.disabled=true;
	      */
	     show_control_view(false);
	     
	 }
     }
     else{
	 camb.start({
	     message: "Camera is <strong>available</strong>, click the <i>'Use camera'</i> button to take control!",
	     button_message: "Use camera",
	     start_cb: function(){
		 camb.wait({ message : "Locking camera ..." });
		 sbc.cam.use(function(init_msg){
		     console.log("use message " + JSON.stringify(init_msg));
		     
		 }).then(function(init_data){
		     		     
		     if(init_data.type=="success"){
		     }			 
		     console.log("LOCKING DONE OK! " + JSON.stringify(init_data, null, 10));

		     sbc.monitor_temperature(true);
		     sbc.update_button();
		     

		     
		 }).catch(function(m){
		     camb.error({ message : "Error locking camera : " + m, button_message : "Retry",
				  error_cb : sbc.update_button
		     });
		 });
		 
	     }});
	 
	 /* sbc.status.innerHTML="Camera is <strong>available</strong>, click the <i>'Use camera'</i> button to take control!";
	    sbc.use_camera.disabled=false;
	    sbc.use_camera.innerHTML="Use camera";
	    sbc.use_camera.className="btn btn-primary";
	  */
	 show_control_view(false);
	 
     }
     
 }
 /* 
  * sbc.use_camera.addEventListener("click", function(){
  *     sbc.cam.use().then(function(){
    sbc.update_button();
  *     }).catch(function(e){
    //sbc.use_camera.className="btn btn-danger";
    //sbc.use_camera.innerHTML=
    camb.error({message : e.toString()});
  *     });
  * });
  */
 
 
 sbc.cam=new sbig_camera();
 
</script>
