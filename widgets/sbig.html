

<style>

 .sb_top{
     display: flex;
     flex-direction: column;

     flex: 1 1 auto;

     background-color: rgba(10,10,10,.8);
     border-radius: 1em;
     color: #aaa;
     max-width: 100%;
     overflow-x: hide;
 }

 .sb_top > .console{
     background-color: rgba(0,255,0,.2);
     border: 1px solid springgreen;
      }
 
 .sb_container{
     flex: 2 1 auto;
     display: flex;
     flex-direction: column;
     overflow-y: auto;
     overflow-x: hidden;
 }

 .sbig_toolbar {
     flex: 0 1 auto;
     display: flex;
     flex-direction: row;
     align-items : center;
     align-content : center;
     padding: .5rem;
     background : rgba(10,10,10,.7);
 }
 .sb_title{
     flex: 0 1 auto;
     color: #bbb;
 }

 .sb_server{
     flex: 1 1 auto;
     color: #bbb;
     text-align: right;
 }

 .sb_camera_info {
     flex: 0 1 auto;

     display: flex;
     flex-direction: column;
     text-align: right;
 }
 
 /*
 .form-control{
     border: 1px solid white;
 }
 .input-group-text{
     border: 1px solid white;
 }
 */
 
</style>

<div class="sb_top">

    <div class="sb_server">
	<small>Telescope computer link<x-widget name="ws" data-class="widgets/websocket"></x-widget></small>
	</div>
    
    <div class="sbig_toolbar">
	<h2 class="sb_title">Camera controller</h2>

	<div class="sb_camera_info">
	    <x-widget name="rescan" data-class="widgets/action"> </x-widget>
	    
	</div>

	
    </div>

    
    
    <div class="sb_container text-light">
	
	<x-widget data-class="widgets/container" name="cameras"> </x-widget>
	
	
    </div>

    <x-widget name="sbig_console" data-class="widgets/console"> </x-widget> 
</div>


<script class="builder">


 var sb=this;
 
 var rescan=sb.childs.rescan;
 
 var sbig_handlers = {
     broadcast : function(msg, reply){
	 console.log("BCAST");
     }
 };
 

 rescan.b.classList.add("btn-small");
 
 var sock=sm.new_socket({ mod_pack : sbig_handlers, mod_pack_name : "sbig"});
 sb.childs.ws.attach_client(sock);

 var debug=sb.childs.sbig_console;
 
 function fill_cam_list(cams){
     var n=0;
     for ( var c in cams ){
	 n++;
         let cam=cams[c];

	 //var div=document.createElement("div");
	 //sb.childs.cameras.cnt.appendChild(div);
	 //div.innerHTML=cam.serial + " " + cam.name;
	 
	 factory.create_widget("sbig_camera", sb.childs.cameras, sb.childs.cameras.cnt, "cam"+cam.id).then(function(cam_widget){

	     console.log("Cam widget created : " + c);

	     cam_widget.cam.init(sock,cam);
	     if(cam.uid!==undefined){
		 cam_widget.cam.owner=cam.uid==sm.id_data.session;
		 cam_widget.cam.locked=true;
	     }else cam_widget.cam.locked=false;
	     
	     cam_widget.update_button();
	 });
	 
     }
     return n;
 }
 
 function update_cam_list(){

     debug.newline("Query cam list ...");
     sock.query("sbig/cam_info",function(msg){
	 debug.newline("<pre>"+JSON.stringify(msg.data,null,5)+"</pre>");
	 //debug.newline("Received cam list !");
	 
	 var nc=fill_cam_list(msg.data);
	 

	 rescan.start({ message : nc==0? "<strong class=\"text-danger\">No camera found ! </strong>" : "", // "<strong class='text-warning'>"+nc+" SBIG USB camera found!</strong>",
			button_message : "<i class='fa fa-recycle' style='color : springgreen; font-size: 1.5em;'></i> Rescan USB",
			start_cb: function(){
			    rescan.wait({
				message : "Requesting a new USB scan on telescope server..."
			    });

//			    sb.childs.cameras.destroy_childs();
			    sock.query("sbig/usb_scan",function(msg){
				update_cam_list();
				/* if(msg.data.error!==undefined){
				   rescan.error({ message : msg.data.error, button_message : "Rescan USB", error_cb : update_cam_list});
				   }else
				   fill_cam_list(msg.data);*/
			    });
			    
			}
	 });
	 
     });
     

 }
 
 sock.on("event",function(evt){
     if(evt.status=="opened"){
	 debug.newline("Link established...");
	 update_cam_list()
	 
	 sock.query("system/set_broadcast_stations", { sbig : true} , function(reply){});
     };
 });
 
 sock.mods.install_mod({
     broadcast : function(msg, reply){

	 debug.newline("Broadcast message " + JSON.stringify(msg.data) );

	 switch(msg.data.msg){
	     case"unlocked":
		 var cam_widget=sb.childs.cameras.childs["cam"+msg.data.data.cid];
		 cam_widget.cam.locked=false;
		 cam_widget.cam.owner=false;
		 //debug.newline("Cam widget is " + cam_widget);
		 cam_widget.update_button();
		 break;

		 
     	     case "locked":
		 var cam_widget=sb.childs.cameras.childs["cam"+msg.data.data.cid];
		 cam_widget.cam.locked=true;
		 cam_widget.cam.uid=msg.data.data.uid;
		 if(cam_widget.cam.uid==sm.id_data.session)
		     cam_widget.cam.owner=true ;
		 //debug.newline("Cam widget is " + cam_widget);
		 cam_widget.update_button();
		 break;
		 
	     case "temp_report":
		 //console.log("Temperature " + JSON.stringify(msg.data.data));
		 if(sb.childs.cameras.childs!==undefined){
		     var cam=sb.childs.cameras.childs["cam"+msg.data.data.cid];
		     if(cam!==undefined){
			 var cool=msg.data.data.cooling_info;
			 if(cool.error!==undefined){
			     debug.newline("Cooling report error : " + cool.error);
			 }
			 else{
			     cam.childs.ccd_settings.set_params({
				 cooling : {
				     //setpoint : cool.cooling_setpoint,
				     //enabled : cool.enabled,
				     ccd_temp : cool.ccd_temp,
				     ambient_temp : cool.ambient_temp
				 }
			     });
			     cam.childs.temp_monitor.update_temp(cool);
			 }
		     }
		 }
	 	 
		 break;
	     case "image":
		 if(sb.childs.cameras.childs!==undefined){
		     var cam_widget=sb.childs.cameras.childs["cam"+msg.data.data.cid];
		     if(cam_widget!==undefined){
			 msg.data.bin_data=msg.bin_data;
			 console.log("Message is " + JSON.stringify(msg.data) + " BIN ? " + msg.bin_data);
			 cam_widget.cam.display_image(msg.data);
		     }
		 }
		 break;
	     default: break;
	 }
     }}, "system");
 
 sock.connect().catch(function(error){
     
 });
 
</script>
